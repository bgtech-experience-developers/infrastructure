#!/usr/bin/env bash
set -euo pipefail


ENV_DIR="/root/infrastructure/consulpam/dev"
mkdir -p "$ENV_DIR"

: "${DB_PASSWORD:?DB_PASSWORD n√£o definida}"
: "${DB_USER:?DB_USER n√£o definida}"
: "${PORT:? PORT n√£o definido}"
: "${DB_NAME:?DB_NAME n√£o definida}"
: "${DOCKERHUB_USERNAME:?DOCKERHUB_USERNAME n√£o definida}"
: "${REFRESH_TOKEN:?REFRESH_TOKEN n√£o definido}"
: "${REFRESH_EXPIRE:?REFRESH_EXPIRE n√£o definido}"
: "${RESET_KEY:?RESET_KEY n√£o definido}"
: "${RESET_EXPIRE:?RESET_EXPIRE n√£o definido}"
: "${UPLOAD_DIR_PATH:?UPLOAD_DIR_PATH n√£o definida}"
: "${INVITE_TOKEN:?INVITE_TOKEN n√£o definida}"
: "${RABBITMQ_DEFAULT_USER:?RABBITMQ_DEFAULT_USER n√£o definido}"
: "${RABBITMQ_DEFAULT_PASS:?RABBITMQ_DEFAULT_PASS n√£o definida}"
: "${ACCESS_TOKEN:?ACCESS_TOKEN n√£o definida}"
: "${ACCESS_EXPIRE:?ACCESS_EXPIRE n√£o definida}"
: "${GITHUB_SHA:?GITHUB_SHA n√£o definida}"



cat <<EOF > "$ENV_DIR/.env.stage"
DB_PASSWORD=$DB_PASSWORD
DB_USER=$DB_USER
DB_NAME=$DB_NAME
DATABASE_URL=postgresql://$DB_USER:$DB_PASSWORD@postgres:5432/$DB_NAME
PORT=$PORT
ACCESS_TOKEN=$ACCESS_TOKEN
REFRESH_TOKEN=$REFRESH_TOKEN
REFRESH_EXPIRE=$REFRESH_EXPIRE
ACCESS_EXPIRE=$ACCESS_EXPIRE
RESET_KEY=$RESET_KEY
RESET_EXPIRE=$RESET_EXPIRE
UPLOAD_DIR_PATH=$UPLOAD_DIR_PATH
INVITE_TOKEN=$INVITE_TOKEN
URL_RABBITMQ=amqp://$RABBITMQ_DEFAULT_USER:$RABBITMQ_DEFAULT_PASS@rabbitmq:5672
GITHUB_SHA=$GITHUB_SHA
EOF

cat <<EOF > "$ENV_DIR/.env.compose"
DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME
POSTGRES_PASSWORD=$DB_PASSWORD
EOF

chmod 600 "$ENV_DIR"/.env.*

echo "üß© Arquivos .env gerados"
